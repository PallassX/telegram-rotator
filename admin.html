<!DOCTYPE html>
<html lang="ms">
<head>
  <meta charset="UTF-8" />
  <title>Redirect Telegram | Auto Rotate / Slot Masa</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: Arial, sans-serif; background:#f4f4f4; padding:24px; max-width:720px; margin:auto; text-align:center; }
    h2 { margin-top:56px; }
    .status { font-size:18px; margin-top:18px; color:#0a7c2f; }
    .error { color:#b00020; }
    .muted { color:#666; font-size:14px; margin-top:6px; }
    .badge { display:inline-block; margin-top:10px; padding:6px 10px; border-radius:999px; background:#fff; border:1px solid #ddd; }
  </style>
</head>
<body>
  <h2>üîÅ Sedang Semak Redirect...</h2>
  <div class="badge">Mode: <strong id="modeLabel">-</strong></div>
  <p class="status" id="status">‚è≥ Memeriksa tetapan...</p>
  <p class="muted">Halaman ini auto-redirect. Tiada tindakan diperlukan.</p>

  <script>
    const modeLabel = document.getElementById("modeLabel");
    const statusEl  = document.getElementById("status");

    async function loadSettings() {
      try {
        const res = await fetch('settings.json?_=' + Date.now());
        if (!res.ok) throw new Error("Gagal memuatkan settings.json");
        return await res.json();
      } catch (err) {
        statusEl.classList.add("error");
        statusEl.textContent = "‚ùå Tidak dapat memuatkan tetapan.";
        console.error(err);
        return null;
      }
    }

    // Rotate hanya pada admin yang active=true
    function autoRotate(settings) {
      const list = (settings.rotationAdmins || []).filter(a => a && a.active && a.link);
      if (list.length === 0) {
        statusEl.classList.add("error");
        statusEl.textContent = "‚ùå No admin active right now.";
        return false;
      }
      let idx = parseInt(localStorage.getItem("rotationIndex") || "0", 10);
      idx = (idx + 1) % list.length;
      localStorage.setItem("rotationIndex", String(idx));

      const adm = list[idx];
      statusEl.classList.remove("error");
      statusEl.textContent = `üîÅ Rotate ke: ${adm.name || "Admin"} (index ${idx}) ‚Äî redirect sekarang...`;
      setTimeout(() => { window.location.href = adm.link; }, 400);
      return true;
    }

    // Ikut jadual masa (tak terkesan dengan active)
    function autoSchedule(settings) {
      const now = new Date();
      const malaysiaTime = new Date(now.toLocaleString("en-US", { timeZone: "Asia/Kuala_Lumpur" }));
      const current = malaysiaTime.toTimeString().slice(0, 5);
      const today = malaysiaTime.toISOString().split("T")[0];
      const currentDay = ["Ahad","Isnin","Selasa","Rabu","Khamis","Jumaat","Sabtu"][malaysiaTime.getDay()];

      const match = (settings.timeSlots || []).find(slot => {
        if (slot.type === "byTime")  return current >= slot.start && current <= slot.end;
        if (slot.type === "byDay")   return slot.day === currentDay && current >= slot.start && current <= slot.end;
        if (slot.type === "byDate")  return slot.date === today && current >= slot.start && current <= slot.end;
        return false;
      });

      if (match) {
        statusEl.classList.remove("error");
        statusEl.textContent = `‚úÖ Redirect ke ${match.name} (${current}, ${today})`;
        setTimeout(() => { window.location.href = match.link; }, 1000);
      } else {
        statusEl.classList.add("error");
        statusEl.textContent = `‚ùå Tiada admin aktif sekarang (${current}, ${today})`;
      }
    }

    (async function boot(){
      const settings = await loadSettings();
      if (!settings) return;

      modeLabel.textContent = (settings.mode || 'schedule').replace(/^\w/, c => c.toUpperCase());

      if (settings.mode === "rotate") {
        autoRotate(settings);
      } else {
        autoSchedule(settings);
      }
    })();
  </script>
</body>
</html>
