<!DOCTYPE html>
<html lang="ms">
<head>
  <meta charset="UTF-8" />
  <title>Redirect Telegram | Auto Rotate</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: Arial, sans-serif; background:#f4f4f4; padding:24px; max-width:720px; margin:auto; text-align:center; }
    h2 { margin-top:56px; }
    .status { font-size:18px; margin-top:18px; color:#0a7c2f; }
    .error { color:#b00020; }
    .muted { color:#666; font-size:14px; margin-top:6px; }
    .badge { display:inline-block; margin-top:10px; padding:6px 10px; border-radius:999px; background:#fff; border:1px solid #ddd; }
  </style>
</head>
<body>
  <h2>üîÅ Sedang Semak Redirect (Rotate)</h2>
  <div class="badge"><strong>Mode:</strong> Rotate</div>
  <p class="status" id="status">‚è≥ Memeriksa tetapan...</p>
  <p class="muted">Halaman ini auto-redirect. Tiada tindakan diperlukan.</p>

  <script>
    const statusEl  = document.getElementById("status");

    async function loadSettings() {
      try {
        const res = await fetch('settings.json?_=' + Date.now());
        if (!res.ok) throw new Error("Gagal memuatkan settings.json");
        return await res.json();
      } catch (err) {
        console.warn("Gagal load settings.json, fallback localStorage.", err);
        try {
          const rotationAdmins = JSON.parse(localStorage.getItem("rotationAdmins") || "[]");
          const rotateEnabled  = JSON.parse(localStorage.getItem("rotateEnabled") || "true");
          return { rotationAdmins, rotateEnabled };
        } catch { return null; }
      }
    }

    function autoRotate(rotationAdmins, rotateEnabled) {
      // Global OFF?
      if (rotateEnabled === false) {
        statusEl.classList.add("error");
        statusEl.textContent = "‚õî Rotate dimatikan oleh admin (Global OFF).";
        return;
      }

      const active = (rotationAdmins || []).filter(a => a && (a.enabled !== false));
      if (active.length === 0) {
        statusEl.classList.add("error");
        statusEl.textContent = "‚ùå Tiada admin aktif untuk rotate.";
        return;
      }

      let rotationIndex = parseInt(localStorage.getItem("rotationIndex") || "0", 10);
      rotationIndex = (rotationIndex + 1) % active.length;
      localStorage.setItem("rotationIndex", rotationIndex);

      const adm = active[rotationIndex];
      statusEl.classList.remove("error");
      statusEl.textContent = `üîÅ Rotate ke: ${adm.name} (index ${rotationIndex}) ‚Äî redirect sekarang...`;
      setTimeout(() => { window.location.href = adm.link; }, 400);
    }

    (async function boot(){
      const settings = await loadSettings();
      if (!settings) {
        statusEl.classList.add("error");
        statusEl.textContent = "‚ùå Tidak dapat memuatkan tetapan.";
        return;
      }
      autoRotate(settings.rotationAdmins || [], settings.rotateEnabled !== false);
    })();
  </script>
</body>
</html>
