<!DOCTYPE html>
<html lang="ms">
<head>
  <meta charset="UTF-8" />
  <title>Redirect Telegram | Auto Rotate / Slot Masa</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: Arial, sans-serif; background:#f4f4f4; padding:24px; max-width:720px; margin:auto; text-align:center; }
    h2 { margin-top:56px; }
    .status { font-size:18px; margin-top:18px; color:#0a7c2f; }
    .error { color:#b00020; }
    .muted { color:#666; font-size:14px; margin-top:6px; }
    .badge { display:inline-block; margin-top:10px; padding:6px 10px; border-radius:999px; background:#fff; border:1px solid #ddd; }
  </style>
</head>
<body>
  <h2>ğŸ” Sedang Semak Redirect...</h2>
  <div class="badge">Mode: <strong id="modeLabel">-</strong></div>
  <p class="status" id="status">â³ Memeriksa tetapan...</p>
  <p class="muted">Halaman ini autoâ€‘redirect. Tiada tindakan diperlukan.</p>

  <script>
    // ====== Ambil data dari localStorage (diset melalui admin panel) ======
    const mode = localStorage.getItem("mode") || "schedule";              // 'schedule' | 'rotate'
    const timeSlots = JSON.parse(localStorage.getItem("timeSlots") || "[]");
    const rotationAdmins = JSON.parse(localStorage.getItem("rotationAdmins") || "[]");
    let rotationIndex = parseInt(localStorage.getItem("rotationIndex") || "0", 10);

    // UI kecil
    const modeLabel = document.getElementById("modeLabel");
    const statusEl  = document.getElementById("status");
    modeLabel.textContent = mode.charAt(0).toUpperCase() + mode.slice(1);

    function saveRotationIndex(){ localStorage.setItem("rotationIndex", String(rotationIndex)); }

    // ====== AUTO-ROTATE (Mode: Rotate) ======
    function autoRotateIfNeeded() {
      if (mode !== "rotate") return false;                       // bukan rotate
      if (!Array.isArray(rotationAdmins) || rotationAdmins.length === 0) return false;

      rotationIndex = (rotationIndex + 1) % rotationAdmins.length;
      saveRotationIndex();

      const adm = rotationAdmins[rotationIndex];
      if (!adm || !adm.link) return false;

      statusEl.classList.remove("error");
      statusEl.textContent = `ğŸ” Rotate ke: ${adm.name || "Admin"} (index ${rotationIndex}) â€” redirect sekarang...`;
      setTimeout(() => { window.location.href = adm.link; }, 400);
      return true;
    }

    // ====== AUTO-SCHEDULE (Mode: Schedule) ======
    function autoRedirectBySchedule() {
      const now = new Date();
      const malaysiaTime = new Date(now.toLocaleString("en-US", { timeZone: "Asia/Kuala_Lumpur" }));
      const current = malaysiaTime.toTimeString().slice(0, 5); // HH:MM
      const today = malaysiaTime.toISOString().split("T")[0];  // yyyy-mm-dd
      const currentDay = ["Ahad","Isnin","Selasa","Rabu","Khamis","Jumaat","Sabtu"][malaysiaTime.getDay()];

      const match = timeSlots.find(slot => {
        if (!slot) return false;
        if (slot.type === "byTime")  return current >= slot.start && current <= slot.end;
        if (slot.type === "byDay")   return slot.day === currentDay && current >= slot.start && current <= slot.end;
        if (slot.type === "byDate")  return slot.date === today && current >= slot.start && current <= slot.end;
        return false;
      });

      if (match) {
        statusEl.classList.remove("error");
        statusEl.textContent = `âœ… Redirect ke ${match.name} (${current}, ${today})`;
        setTimeout(() => { window.location.href = match.link; }, 1000);
      } else {
        statusEl.classList.add("error");
        statusEl.textContent = `âŒ Tiada admin aktif sekarang (${current}, ${today})`;
      }
    }

    // ====== BOOT ======
    (function boot(){
      // Jangan auto-redirect di admin page
      const isAdminPage = window.location.pathname.includes("admin.html");
      if (isAdminPage) {
        statusEl.textContent = "ğŸ‘¨â€ğŸ’» Ini halaman admin â€” tiada auto-redirect.";
        return;
      }

      // Public page behaviour
      const rotated = autoRotateIfNeeded();   // cuba rotate jika mode=rotate
      if (!rotated) autoRedirectBySchedule(); // kalau tak, cuba ikut slot masa
    })();
  </script>
</body>
</html>